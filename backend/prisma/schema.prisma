generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id            String    @id @default(uuid())
  email         String    @unique
  password_hash String
  first_name    String
  last_name     String
  role          String    @default("staff")
  is_active     Boolean   @default(true)
  last_login_at DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  // Relations
  created_products  products[]          @relation("ProductCreator")
  created_documents documents[]         @relation("DocumentCreator")
  validated_documents documents[]       @relation("DocumentValidator")
  stock_movements   stock_movements[]

  @@index([email])
  @@index([role])
}

model warehouses {
  id         String   @id @default(uuid())
  code       String   @unique
  name       String
  address    String?
  capacity   Decimal? @db.Decimal(10, 2)
  manager    String?
  phone      String?
  is_active  Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relations
  product_stock          product_stock[]
  movements_from         stock_movements[] @relation("WarehouseFrom")
  movements_to           stock_movements[] @relation("WarehouseTo")

  @@index([code])
  @@index([is_active])
}

model products {
  id               String   @id @default(uuid())
  sku              String   @unique
  name             String
  description      String?
  category         String
  unit_of_measure  String
  unit_price       Decimal  @default(0) @db.Decimal(10, 2)
  reorder_point    Int      @default(0)
  max_stock_level  Int?
  supplier         String?
  is_active        Boolean  @default(true)
  created_by       String
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  // Relations
  creator          users            @relation("ProductCreator", fields: [created_by], references: [id])
  product_stock    product_stock[]
  document_lines   document_lines[]
  stock_movements  stock_movements[]

  @@index([sku])
  @@index([category])
  @@index([is_active])
}

model product_stock {
  id                String    @id @default(uuid())
  product_id        String
  warehouse_id      String
  quantity_on_hand  Int       @default(0)
  quantity_reserved Int       @default(0)
  last_counted_at   DateTime?
  updated_at        DateTime  @updatedAt

  // Relations
  product   products   @relation(fields: [product_id], references: [id], onDelete: Cascade)
  warehouse warehouses @relation(fields: [warehouse_id], references: [id], onDelete: Cascade)

  @@unique([product_id, warehouse_id])
  @@index([product_id])
  @@index([warehouse_id])
}

model documents {
  id               String    @id @default(uuid())
  document_number  String    @unique
  document_type    String
  status           String    @default("draft")
  reference_number String?
  partner_name     String?
  scheduled_date   DateTime?
  validated_at     DateTime?
  validated_by     String?
  created_by       String
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  // Relations
  creator          users              @relation("DocumentCreator", fields: [created_by], references: [id])
  validator        users?             @relation("DocumentValidator", fields: [validated_by], references: [id])
  lines            document_lines[]
  stock_movements  stock_movements[]

  @@index([document_number])
  @@index([document_type])
  @@index([status])
  @@index([scheduled_date])
}

model document_lines {
  id          String   @id @default(uuid())
  document_id String
  product_id  String
  quantity    Int
  unit_price  Decimal  @default(0) @db.Decimal(10, 2)
  notes       String?
  created_at  DateTime @default(now())

  // Relations
  document documents @relation(fields: [document_id], references: [id], onDelete: Cascade)
  product  products  @relation(fields: [product_id], references: [id])

  @@index([document_id])
  @@index([product_id])
}

model stock_movements {
  id                 String   @id @default(uuid())
  movement_type      String
  document_id        String?
  product_id         String
  from_warehouse_id  String?
  to_warehouse_id    String?
  quantity           Int
  unit_price         Decimal? @db.Decimal(10, 2)
  reference_number   String?
  notes              String?
  created_by         String
  created_at         DateTime @default(now())

  // Relations
  document       documents?   @relation(fields: [document_id], references: [id])
  product        products     @relation(fields: [product_id], references: [id])
  from_warehouse warehouses?  @relation("WarehouseFrom", fields: [from_warehouse_id], references: [id])
  to_warehouse   warehouses?  @relation("WarehouseTo", fields: [to_warehouse_id], references: [id])
  user           users        @relation(fields: [created_by], references: [id])

  @@index([movement_type])
  @@index([product_id])
  @@index([from_warehouse_id])
  @@index([to_warehouse_id])
  @@index([created_at])
}
